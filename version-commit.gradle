import java.text.SimpleDateFormat

//使用默认task的方式嵌入
//defaultTasks 'versionCommit'
task("versionCommit"){
    versionCommit()
}
//在processResources之后执行
processResources.finalizedBy versionCommit

static def versionCommit() {
    Properties p = new Properties()
    p.put("branch", getGitBranch())
    p.put("commitId", getGitCommit())
    p.put("commitAuthor", getGitCommitAuthor())
    p.put("commitTime", getGitCommitTime())
    p.put("packageTime", getCurrentTime())
    p.store(new FileWriter("src/main/resources/version-commit.properties"), "generated by gradle git info plugin")
}
static def getGitCommit() {
    return 'git rev-parse --short HEAD'.execute().text.trim()
}

static def getGitCommitAuthor() {
    String commitId = getGitCommit();
    String cmd = "git log --pretty=format:%an $commitId -1";
    return cmd.execute().text.trim()
}
static def getGitCommitTime() {
    String commitId = getGitCommit();
    String cmd = "git log --pretty=format:%ai $commitId -1";
    return cmd.execute().text.trim();
}
static def getGitBranch() {
    return (System.getProperty("version") ?: "1.0-SNAPSHOT").replace("origin/", "")
}
static def getCurrentTime() {
    return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date())
}


